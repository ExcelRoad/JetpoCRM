{% extends 'base/base_layout.html' %}
{% load static %}
{% load humanize %}

{% block breadcrumbs %}
    <a href="{% url 'homePage' %}">
        בית
    </a>
    <p class="flex items-center gap-1">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11 6L21 6.00072M11 12L21 12.0007M11 18L21 18.0007M3 11.9444L4.53846 13.5L8 10M3 5.94444L4.53846 7.5L8 4M4.5 18H4.51M5 18C5 18.2761 4.77614 18.5 4.5 18.5C4.22386 18.5 4 18.2761 4 18C4 17.7239 4.22386 17.5 4.5 17.5C4.77614 17.5 5 17.7239 5 18Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
       משימות
    </p>
{% endblock breadcrumbs %}

{% block content %}
<div x-data="setSection()" x-init="$store.selectedMainTab.change('tasks')">
    <div class="px-4 py-6 w-full flex items-center justify-between border-b border-gray-200">
        <div>
            <h1 class="font-semibold text-3xl mb-1">משימות</h1>
            <p class="text-gray-400">זוהי רשימה של כל משימות שלך. מכאן תוכלו לארגן, לנהל ולערוך את המשימות שלכם</p>
        </div>
        <div class="">
        </div>
    </div>
    <div x-data="leadKanbanHandler()">
        <div class="p-8" >
        <!-- Action Section -->
         <div class="flex items-center justify-between">
            <form class="relative" id="projectSearch">
                <input type="text" class="input-field-search" placeholder="חפש לפי שם, לקוח או פרויקט " x-model="searchQuery">
                <div class="absolute text-gray-400 w-5 top-1 right-2">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 9.00006H6.2C5.0799 9.00006 4.51984 9.00006 4.09202 9.21805C3.71569 9.40979 3.40973 9.71575 3.21799 10.0921C3 10.5199 3 11.08 3 12.2001V17.8001C3 18.9202 3 19.4802 3.21799 19.908C3.40973 20.2844 3.71569 20.5903 4.09202 20.7821C4.51984 21.0001 5.07989 21.0001 6.2 21.0001H17.787C18.9071 21.0001 19.4671 21.0001 19.895 20.7821C20.2713 20.5903 20.5772 20.2844 20.769 19.908C20.987 19.4802 20.987 18.9202 20.987 17.8001V12.0001M6 15.0001H6.01M10 15H10.01M11.5189 12.8946L12.8337 12.6347C13.5432 12.4945 13.8979 12.4244 14.2287 12.2953C14.5223 12.1807 14.8013 12.0318 15.06 11.8516C15.3514 11.6487 15.607 11.393 16.1184 10.8816L21.2668 5.73321C21.9541 5.04596 21.9541 3.9317 21.2668 3.24444C20.5796 2.55719 19.4653 2.55719 18.7781 3.24445L13.5416 8.48088C13.0625 8.96004 12.8229 9.19963 12.6294 9.47121C12.4576 9.71232 12.3131 9.97174 12.1986 10.2447C12.0696 10.5522 11.9921 10.8821 11.837 11.5417L11.5189 12.8946Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </form>
            <div class="flex items-center gap-2" x-data="{MoreBtnShow : false}">
                <!-- Additional Actions -->
                <div class="btn-action relative " @click="MoreBtnShow = !MoreBtnShow" @click.outside="MoreBtnShow = false" x-show="selectedIds.length > 0">
                    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m8 10 4 4 4-4" />
                    </svg>
                   עוד פעולות
                    <div class="p-2 flex flex-col z-50 absolute top-10 border border-gray-200 shadow rounded-lg right-0 w-54 bg-white" x-show="MoreBtnShow">
                        <form method="post" action="{% url 'task-mass-complete' %}">
                            {% csrf_token %}
                            <input type="hidden" name="tasks" x-model="selectedIds">
                            <button class="nav-btn">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M11 4H7.2C6.0799 4 5.51984 4 5.09202 4.21799C4.71569 4.40974 4.40973 4.7157 4.21799 5.09202C4 5.51985 4 6.0799 4 7.2V16.8C4 17.9201 4 18.4802 4.21799 18.908C4.40973 19.2843 4.71569 19.5903 5.09202 19.782C5.51984 20 6.0799 20 7.2 20H16.8C17.9201 20 18.4802 20 18.908 19.782C19.2843 19.5903 19.5903 19.2843 19.782 18.908C20 18.4802 20 17.9201 20 16.8V12.5M15.5 5.5L18.3284 8.32843M10.7627 10.2373L17.411 3.58902C18.192 2.80797 19.4584 2.80797 20.2394 3.58902C21.0205 4.37007 21.0205 5.6364 20.2394 6.41745L13.3774 13.2794C12.6158 14.0411 12.235 14.4219 11.8012 14.7247C11.4162 14.9936 11.0009 15.2162 10.564 15.3882C10.0717 15.582 9.54378 15.6885 8.48793 15.9016L8 16L8.04745 15.6678C8.21536 14.4925 8.29932 13.9048 8.49029 13.3561C8.65975 12.8692 8.89125 12.4063 9.17906 11.9786C9.50341 11.4966 9.92319 11.0768 10.7627 10.2373Z"
                                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                השלמה מרובה
                            </button>
                        </form>
                        <button class="nav-btn">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 4L12 12M20 4V8.5M20 4H15.5M19 12.5V16.8C19 17.9201 19 18.4802 18.782 18.908C18.5903 19.2843 18.2843 19.5903 17.908 19.782C17.4802 20 16.9201 20 15.8 20H7.2C6.0799 20 5.51984 20 5.09202 19.782C4.71569 19.5903 4.40973 19.2843 4.21799 18.908C4 18.4802 4 17.9201 4 16.8V8.2C4 7.0799 4 6.51984 4.21799 6.09202C4.40973 5.71569 4.71569 5.40973 5.09202 5.21799C5.51984 5 6.07989 5 7.2 5H11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                           ייצוא
                        </button>
                        <hr class="text-gray-200 my-1">
                        <button class="nav-btn danger" @click="modelBackgroundShow = true, massDeleteModelShow = true">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6M18 6V16.2C18 17.8802 18 18.7202 17.673 19.362C17.3854 19.9265 16.9265 20.3854 16.362 20.673C15.7202 21 14.8802 21 13.2 21H10.8C9.11984 21 8.27976 21 7.63803 20.673C7.07354 20.3854 6.6146 19.9265 6.32698 19.362C6 18.7202 6 17.8802 6 16.2V6M14 10V17M10 10V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          מחיקה
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-start px-4">
                    <button :class="selectTab=='all' ? 'btn-tab active' : 'btn-tab' " @click="selectTab='all'">הכל</button>
                    <button :class="selectTab=='open' ? 'btn-tab active' : 'btn-tab' " @click="selectTab='open'">פתוחות</button>
                    <button :class="selectTab=='completed' ? 'btn-tab active' : 'btn-tab' " @click="selectTab='completed'">הושלמו</button>
                </div>
                <button class="btn-action">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M3 4.6C3 4.03995 3 3.75992 3.10899 3.54601C3.20487 3.35785 3.35785 3.20487 3.54601 3.10899C3.75992 3 4.03995 3 4.6 3H19.4C19.9601 3 20.2401 3 20.454 3.10899C20.6422 3.20487 20.7951 3.35785 20.891 3.54601C21 3.75992 21 4.03995 21 4.6V6.33726C21 6.58185 21 6.70414 20.9724 6.81923C20.9479 6.92127 20.9075 7.01881 20.8526 7.10828C20.7908 7.2092 20.7043 7.29568 20.5314 7.46863L14.4686 13.5314C14.2957 13.7043 14.2092 13.7908 14.1474 13.8917C14.0925 13.9812 14.0521 14.0787 14.0276 14.1808C14 14.2959 14 14.4182 14 14.6627V17L10 21V14.6627C10 14.4182 10 14.2959 9.97237 14.1808C9.94787 14.0787 9.90747 13.9812 9.85264 13.8917C9.7908 13.7908 9.70432 13.7043 9.53137 13.5314L3.46863 7.46863C3.29568 7.29568 3.2092 7.2092 3.14736 7.10828C3.09253 7.01881 3.05213 6.92127 3.02763 6.81923C3 6.70414 3 6.58185 3 6.33726V4.6Z"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    סינון
                </button>
            </div>
         </div>
        <!-- Tasks Table -->
         {% if tasks %}
         <div class="table-wrapper">
            
            <table class="w-full relative">
                <thead class="h-full">
                    <tr class="table-header-row">
                        <th>
                            <input
                                type="checkbox"
                                name="headerCheckbox"
                                id="headerCheckbox"
                                class="input-checkbox"
                                @change="toggleSelectAll()"
                                :checked="isAllVisibleSelected()"
                                :indeterminate="isSomeVisibleSelected()"
                            >
                        </th>
                        <th class="table-header-item"></th>
                        <th class="table-header-item">שם</th>
                        <th class="table-header-item">לקוח</th>
                        <th class="table-header-item">פרויקט</th>
                        <th class="table-header-item">תיאור</th>
                        <th class="table-header-item">סטטוס</th>
                        <th class="table-header-item">דחיפות</th>
                        <th class="table-header-item">שעות מדווחות</th>
                        <th class="table-header-item"></th>
                    </tr>
                </thead>
                <tbody class="">
                    {% for task in tasks %}
                    <tr class="table-body-item" :class="selectedIds.includes('{{task.id}}') ? 'bg-gray-100' : '' "
                        x-show="matchesSearch($el) && (selectTab=='all' || (selectTab=='open' && '{{task.is_completed}}' == 'False') || (selectTab=='completed' && '{{task.is_completed}}' == 'True'))"
                        data-payment-id="{{task.id}}" 
                        data-search-name="{{task.name}}" 
                        data-search-project="{{task.project.name}}" 
                        data-search-number="{{task.project.customer.name}}"
                    >
                        <td class="flex items-center justify-center">
                            <input type="checkbox" name="{{task.id}}" id="{{task.id}}" class="input-checkbox" x-model="selectedIds" :value="{{task.id}}">
                        </td>
                        <td>
                            {% if not task.is_completed %}
                            <form method="post" action="{% url 'task-complete' task.id True %}">
                                {% csrf_token %}
                                <button type="submit" class="w-fit text-emerald-600 bg-emerald-50 px-1 py-0.5 rounded-lg hover:bg-emerald-100 cursor-pointer">✓</button>
                            </form>
                            {% endif %}
                        </td>
                        
                        <td>
                            <p class="font-semibold">{{ task.title }}</p>
                        </td>
                        <td>
                            <a class="btn-ghost w-fit" href="{% url 'customer-detail' task.content_object.customer.id %}">
                                <img src="{% if task.content_object.customer.logo %}{{ task.content_object.customer.logo.url }}{% else %}{% static 'images/default-avater.png' %}{% endif %}" alt="Customer Logo" class="h-6 w-6 squircle">
                                {{ task.content_object.customer.name }}
                            </a>
                        </td>
                        <td>
                            <a class="btn-ghost w-fit" href="{% url 'project-detail' task.content_object.id %}">
                                {{ task.content_object.name }}
                            </a>
                        </td>
                        <td>{{ task.description|truncatewords:25 }}</td>
                        <td>
                            <span class="status-pill {% if task.is_completed %}success{% else %}proccess{% endif %}">{% if task.is_completed == True %}הושלמה{% else %}פתוחה{% endif %}</span>
                        </td>
                        <td><span class="status-pill {% if task.urgency == 'low' %}success{% elif task.urgency == 'medium' %}alert{% elif task.urgency == 'high' %}danger{% elif task.urgency == 'critical' %}proccess{% endif %}">{{ task.get_urgency_display }}</span></td>
                        <td>{{ task.reported_timesheet }}</td>
                        <td></td>
                        
                        <td x-data="{ modeOptions : false}">
                            <div class="size-6 p-1 rounded hover:bg-gray-200 cursor-pointer relative" @click="modeOptions = !modeOptions" @click.outside="modeOptions = false">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 12H18.01M12 12H12.01M6 12H6.01M13 12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12ZM19 12C19 12.5523 18.5523 13 18 13C17.4477 13 17 12.5523 17 12C17 11.4477 17.4477 11 18 11C18.5523 11 19 11.4477 19 12ZM7 12C7 12.5523 6.55228 13 6 13C5.44772 13 5 12.5523 5 12C5 11.4477 5.44772 11 6 11C6.55228 11 7 11.4477 7 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div class="p-2 flex flex-col z-100 absolute top-7 border border-gray-200 shadow rounded-lg -right-36 w-44 bg-white" x-show="modeOptions">
                                    <button class="nav-btn" @click="modelBackgroundShow = true, taskModelShow = true, selectedTask = '{{task.id}}', selectedTaskTitle = '{{task.title}}', selectedTaskDescription = '{{task.description}}', selectedTaskUrgency = '{{task.urgency}}', taskModelTitle = 'עריכת משימה'">
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M11 4H7.2C6.0799 4 5.51984 4 5.09202 4.21799C4.71569 4.40974 4.40973 4.7157 4.21799 5.09202C4 5.51985 4 6.0799 4 7.2V16.8C4 17.9201 4 18.4802 4.21799 18.908C4.40973 19.2843 4.71569 19.5903 5.09202 19.782C5.51984 20 6.0799 20 7.2 20H16.8C17.9201 20 18.4802 20 18.908 19.782C19.2843 19.5903 19.5903 19.2843 19.782 18.908C20 18.4802 20 17.9201 20 16.8V12.5M15.5 5.5L18.3284 8.32843M10.7627 10.2373L17.411 3.58902C18.192 2.80797 19.4584 2.80797 20.2394 3.58902C21.0205 4.37007 21.0205 5.6364 20.2394 6.41745L13.3774 13.2794C12.6158 14.0411 12.235 14.4219 11.8012 14.7247C11.4162 14.9936 11.0009 15.2162 10.564 15.3882C10.0717 15.582 9.54378 15.6885 8.48793 15.9016L8 16L8.04745 15.6678C8.21536 14.4925 8.29932 13.9048 8.49029 13.3561C8.65975 12.8692 8.89125 12.4063 9.17906 11.9786C9.50341 11.4966 9.92319 11.0768 10.7627 10.2373Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        עריכה
                                    </button>
                                    <hr class="text-gray-200 my-1">
                                    <button class="nav-btn danger" @click="modelBackgroundShow = true, taskDeleteModelShow = true, selectedTask = '{{task.id}}', selectedTaskName = '{{ task.title }}'">
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6M18 6V16.2C18 17.8802 18 18.7202 17.673 19.362C17.3854 19.9265 16.9265 20.3854 16.362 20.673C15.7202 21 14.8802 21 13.2 21H10.8C9.11984 21 8.27976 21 7.63803 20.673C7.07354 20.3854 6.6146 19.9265 6.32698 19.362C6 18.7202 6 17.8802 6 16.2V6M14 10V17M10 10V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        מחיקה
                                    </button>
                                </div>
                            </div> 
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
         </div>
         <!-- Table Footer Section -->
         <div class="flex items-center justify-between mt-2 p-2">
            <div class="text-gray-500 flex items-center gap-2">
                <span class="flex items-center gap-1">
                    <p x-text="selectedIds.length"></p>
                   <p> מתוך {{ tasks.count }} משימות נבחרו </p>
                </span>
                <a class="text-link" x-show="selectedIds.length != {{tasks.count}}"
                @click="toggleSelectAll()">בחר את כל משימות ({{tasks.count}})</a>
            </div>
            <div class="flex items-center justify-center gap-4">
                <div class="flex items-center gap-1">
                    <p>שורות לדף</p>
                    <select name="" id="" class="btn-action">
                        <option value="10">10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="flex items-center justify-center gap-1">
                    <p>עמוד</p>
                    <p>1</p>
                    <p>מתוך</p>
                    <p>10</p>
                </div>
                <div class="flex items-center justify-center gap-1">
                    <button class="btn-action disabled">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="btn-action">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
         </div>
         
        {% else %}
        <!-- No Content Section -->
        <div class="border-dashed border-2 border-gray-200 flex flex-col items-center justify-center rounded-xl p-6 gap-4 text-center mt-2">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 text-gray-400 -mb-2">
                <path
                    d="M13.2686 14.2686L15 16M12.0627 6.06274L11.9373 5.93726C11.5914 5.59135 11.4184 5.4184 11.2166 5.29472C11.0376 5.18506 10.8425 5.10425 10.6385 5.05526C10.4083 5 10.1637 5 9.67452 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V15.8C3 16.9201 3 17.4802 3.21799 17.908C3.40973 18.2843 3.71569 18.5903 4.09202 18.782C4.51984 19 5.07989 19 6.2 19H17.8C18.9201 19 19.4802 19 19.908 18.782C20.2843 18.5903 20.5903 18.2843 20.782 17.908C21 17.4802 21 16.9201 21 15.8V10.2C21 9.0799 21 8.51984 20.782 8.09202C20.5903 7.71569 20.2843 7.40973 19.908 7.21799C19.4802 7 18.9201 7 17.8 7H14.3255C13.8363 7 13.5917 7 13.3615 6.94474C13.1575 6.89575 12.9624 6.81494 12.7834 6.70528C12.5816 6.5816 12.4086 6.40865 12.0627 6.06274ZM14 12.5C14 13.8807 12.8807 15 11.5 15C10.1193 15 9 13.8807 9 12.5C9 11.1193 10.1193 10 11.5 10C12.8807 10 14 11.1193 14 12.5Z"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <div class="flex flex-col gap-2">
                <h3 class="text-xl font-semibold">לא קיימות משימות במערכת עדיין</h3>
                <p class="text-gray-400">צור משימה חדשה או ייבא משימות מתוך קובץ <br> ניתן לעלות קבצים מסוג xlsx או csv</p>
            </div>
            
            <a class="btn-main" href="{% url 'project-create' %}">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 12H20M12 4V20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <p>פרויקט חדש</p>
            </a>
        </div>
        {% endif %}
    </div>
    <div class="fixed top-0 right-0 h-screen w-screen bg-black/30 flex items-start justify-center pt-60" x-show="modelBackgroundShow">
        <!-- Delete Confirmation Model For Multiple Records-->
        <div class="relative bg-white border border-gray-200 shadow rounded-lg px-4 py-2 min-w-1/4 min-h-1/5 flex flex-col" x-show="massDeleteModelShow">
            <button class="absolute top-2 left-2 [&>svg]:size-6 p-0.5 rounded hover:bg-gray-50 cursor-pointer" @click="modelBackgroundShow = false, massDeleteModelShow = false">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 6L18 18M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="flex-1">
                <h1 class="text-xl font-semibold my-3">מחיקת תשלומים</h1>
                <p class="text-gray-500">
                    אתה עומד  <strong class="text-gray-900" x-text="'למחוק ' + selectedIds.length"></strong> תשלומים שנבחרו.
                </p>
                <p class="text-gray-500">פעולה זו אינה ניתנת לשחזור</p>
            </div>
            <div class="flex items-center justify-end gap-2">
                <form method="post" action="{% url 'payment-mass-delete' %}">
                    {% csrf_token %}
                    <input type="text" name="fallback" value="payment-list" class="hidden">
                    <input type="text" name="paymentList" :value="selectedIds" class="hidden">
                    <button class="btn-action danger high" type="submit">
                        מחיקה
                    </button>
                </form>
                <button class="btn-action" @click="modelBackgroundShow = false, massDeleteModelShow = false">
                    ביטול
                </button>
            </div>
        </div>
        <!-- Delete Confirmation Model For Single Record-->
        <div class="relative bg-white border border-gray-200 shadow rounded-lg px-4 py-4 min-w-1/4 min-h-1/5 flex flex-col" x-show="singleDeleteModelShow">
            <button class="absolute top-2 left-2 [&>svg]:size-6 p-0.5 rounded hover:bg-gray-50 cursor-pointer" @click="modelBackgroundShow = false, singleDeleteModelShow = false">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 6L18 18M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="flex-1">
                <h1 class="text-xl font-semibold my-3">מחיקת פרויקט</h1>
                <span class="flex gap-2 items-center">
                    <p class="text-gray-500">אתה עומד למחוק את</p>
                    <p class="text-gray-900 text-semibold" x-text="selectedProjectName"></p>
                </span>
                <p class="text-gray-500">פעולה זו אינה ניתנת לשחזור</p>
            </div>
            <div class="flex items-center justify-end gap-2">
                <form method="post" :action="'{% url 'project-delete' pk=999999 %}'.replace('999999', selectedProject)">
                    {% csrf_token %}
                    <input type="text" name="fallback" value="project-list" class="hidden">
                    <button class="btn-action danger high" type="submit">
                     מחיקה
                    </button>
                </form>
                
                <button class="btn-action" @click="modelBackgroundShow = false, singleDeleteModelShow = false">
                    ביטול
                </button>
            </div>
        </div>
        <!-- Task Form Model -->
        <div class="relative bg-white border border-gray-200 shadow rounded-lg px-4 py-4 min-w-1/4 min-h-1/5 flex flex-col" x-show="taskModelShow" x-cloak>
            <button class="absolute top-2 left-2 [&>svg]:size-6 p-0.5 rounded hover:bg-gray-50 cursor-pointer" @click="modelBackgroundShow = false, taskModelShow = false">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 6L18 18M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="flex-1">
                <h1 class="text-xl font-semibold my-3" x-text="taskModelTitle"></h1>
            </div>
            <div class="flex items-center justify-end gap-2">
                <form method="post" :action="'{% url 'task-create-update' pk=999999 %}'.replace('999999', selectedTask)" class="w-full">
                    {% csrf_token %}
                    <input type="text" name="fallback" value="project-detail" class="hidden">
                    <input type="text" name="project" value="{{project.id}}" class="hidden">
                    <div class="flex flex-col gap-1">
                        <label for="taskTitle" class="text-gray-600">כותרת</label>
                        <input type="text" id="taskTitle" name="taskTitle" :value="selectedTaskTitle" class="input-field">
                        <label for="taskUrgency" class="text-gray-600">דחיפות</label>
                        <fieldset >
                            <div class="flex items-center gap-2">
                                <div :class="selectedTaskUrgency == 'low' ? 'bg-blue-50 border-blue-200' : 'border-white'" class="border p-2 rounded-lg">
                                    <input type="radio" id="lowUrgency" name="taskUrgency" value="low" checked class="hidden">
                                    <label for="lowUrgency" class="status-pill success cursor-pointer" @click="selectedTaskUrgency = 'low'">נמוכה</label>
                                </div>
                                <div :class="selectedTaskUrgency == 'medium' ? 'bg-blue-50 border-blue-200' : 'border-white'" class="border p-2 rounded-lg">
                                    <input type="radio" id="mediumUrgency" name="taskUrgency" value="medium" class="hidden">
                                    <label for="mediumUrgency" class="status-pill alert cursor-pointer" @click="selectedTaskUrgency = 'medium'">בינונית</label>
                                </div>
                                <div :class="selectedTaskUrgency == 'high' ? 'bg-blue-50 border-blue-200' : 'border-white'" class="border p-2 rounded-lg">
                                    <input type="radio" id="highUrgency" name="taskUrgency" value="high" class="hidden">
                                    <label for="highUrgency" class="status-pill danger cursor-pointer" @click="selectedTaskUrgency = 'high'">גבוהה</label>
                                </div>
                                <div :class="selectedTaskUrgency == 'critical' ? 'bg-blue-50 border-blue-200' : 'border-white'" class="border p-2 rounded-lg">
                                    <input type="radio" id="criticalUrgency" name="taskUrgency" value="critical" class="hidden">
                                    <label for="criticalUrgency" class="status-pill proccess cursor-pointer" @click="selectedTaskUrgency = 'critical'">קריטית</label>
                                </div>
                            </div>
                        </fieldset>
                        <label for="taskDescription" class="text-gray-600">תיאור</label>
                        <textarea id="taskDescription" name="taskDescription" :value="selectedTaskDescription" class="input-field" rows="3"></textarea>
                    </div>
                    <div class="flex items-center gap-2 justify-end mt-2">
                        <button class="btn-main" type="submit">
                             שמירה
                        </button>
                        <a class="btn-action" @click="modelBackgroundShow = false, taskModelShow = false">
                             ביטול
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    function setSection() {
        return {
            selectTab : "all",

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                const section = urlParams.get('section');
                if (section) {
                    this.selectTab = section;
                    // clear the query parameter from URL bar after reading
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
    }
    function leadKanbanHandler() {
        return {
            // State properties
            selectedIds: [],
            modelBackgroundShow: false,
            massDeleteModelShow: false,
            singleDeleteModelShow: false,
            taskModelShow: false,
            taskModelTitle: '',
            selectedTask: 0,
            selectedTaskTitle: '',
            selectedTaskDescription: '',
            selectedTaskUrgency: '',
            searchQuery: '',


            // Check if a card matches the search query
            matchesSearch(card) {
                // If no search query, show all cards
                if (!this.searchQuery || this.searchQuery.trim() === '') {
                    return true;
                }

                // Get search data from the card's data attributes
                const searchName = (card.dataset.searchName || '').toLowerCase();
                const searchProject = (card.dataset.searchProject || '').toLowerCase();
                const searchNumber = (card.dataset.searchNumber || '').toLowerCase();

                // Combine all searchable fields
                const searchableText = `${searchName} ${searchProject} ${searchNumber}`;

                // Check if query matches any field
                const query = this.searchQuery.toLowerCase().trim();
                return searchableText.includes(query);
            },

            // Get count of filtered cards for a specific status
            getFilteredCount(status) {
                const column = document.getElementById(status + '-column');
                if (!column) return 0;

                const cards = column.querySelectorAll('[data-payment-id]');
                let count = 0;

                cards.forEach(card => {
                    if (this.matchesSearch(card)) {
                        count++;
                    }
                });

                return count;
            },

            // Get all visible row IDs
            getVisibleRowIds() {
                const rows = document.querySelectorAll('tbody tr[data-payment-id]');
                const visibleIds = [];

                rows.forEach(row => {
                    if (this.matchesSearch(row)) {
                        const paymentId = parseInt(row.dataset.paymentId);
                        visibleIds.push(paymentId);
                    }
                });

                return visibleIds;
            },

            // Toggle select all visible rows
            toggleSelectAll() {
                const visibleIds = this.getVisibleRowIds();

                // If all visible rows are selected, deselect all
                // Otherwise, select all visible rows
                const allSelected = visibleIds.every(id => this.selectedIds.includes(id));

                if (allSelected) {
                    // Deselect all visible rows
                    this.selectedIds = this.selectedIds.filter(id => !visibleIds.includes(id));
                } else {
                    // Select all visible rows (avoid duplicates)
                    const newSelectedIds = [...new Set([...this.selectedIds, ...visibleIds])];
                    this.selectedIds = newSelectedIds;
                }
            },

            // Check if all visible rows are selected
            isAllVisibleSelected() {
                const visibleIds = this.getVisibleRowIds();
                if (visibleIds.length === 0) return false;
                return visibleIds.every(id => this.selectedIds.includes(id));
            },

            // Check if some (but not all) visible rows are selected
            isSomeVisibleSelected() {
                const visibleIds = this.getVisibleRowIds();
                if (visibleIds.length === 0) return false;

                const selectedCount = visibleIds.filter(id => this.selectedIds.includes(id)).length;
                return selectedCount > 0 && selectedCount < visibleIds.length;
            }
        }
    }
</script>
{% endblock content %}