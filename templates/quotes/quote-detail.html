{% extends 'base/base_layout.html' %}
{% load static %}
{% load humanize %}

{% block breadcrumbs %}
    <a href="{% url 'homePage' %}">בית</a>
    <a href="{% url 'quote-list' %}">הצעות מחיר</a>
    <p class="flex items-center gap-1">
        <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 3H8.2C7.0799 3 6.51984 3 6.09202 3.21799C5.71569 3.40973 5.40973 3.71569 5.21799 4.09202C5 4.51984 5 5.0799 5 6.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.0799 21 8.2 21H13M13 3L19 9M13 3V7.4C13 7.96005 13 8.24008 13.109 8.45399C13.2049 8.64215 13.3578 8.79513 13.546 8.89101C13.7599 9 14.0399 9 14.6 9H19M19 9V10M19.0001 15C17.0027 15 17.0017 15.4862 17.0001 16.3292L17.0001 16.3325C16.9983 17.2328 17.0001 17.5 19.0001 17.5C21.0001 17.5 21.0001 17.7055 21.0001 18.6667C21.0001 19.389 21.0001 20 19.0001 20M19.0001 15L21.0001 15M19.0001 15L19 14M19.0001 20H17.0001M19.0001 20L19 21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
       {{ quote.name }}
    </p>
{% endblock breadcrumbs %}

{% block content %}
<div class="flex h-[846px]" x-data="{modelBackgroundShow : false , singleDeleteModelShow : false, selectedQuote : 0, selectedQuoteName : ''}">
    <!-- Main Section -->
    <div class="w-3/4 h-full" x-data="setSection()" x-init="init()">
        <div class="border-b border-gray-200">
            <div class="px-4 py-6 w-full flex items-center justify-between ">
                <div class="">
                    <div class="flex items-center gap-4">
                        <h1 class="font-semibold text-3xl mb-1">{{ quote.quote_number }} | {{quote.name}}</h1>
                        <span class="status-pill {% if quote.status == 'draft' %}info{% elif quote.status == 'lost' %}danger{% elif quote.status == 'won' %}success{% elif quote.status == 'sent' %}proccess{% endif %}">{{quote.get_status_display}}</span>
                    </div>
                    <a class="btn-ghost w-fit" href="{% url related_to_url quote.object_id %}">
                        {% if quote.content_object.logo %}
                        <img src="{{quote.content_object.logo.url}}" alt="Customer Logo" class="h-6 w-6 squircle">
                        {% endif %}
                        {{ quote.related_to }}
                    </a>
                </div>
                <div class="flex items-center gap-2" x-data="{moreActions : false}">
                    <a class="btn-main" href="">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 14L9 19L20 8M6 8.88889L9.07692 12L16 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p>אישור הצעת מחיר</p>
                    </a>
                    <div class="btn-action relative" @click="moreActions = !moreActions" @click.outside="moreActions = false">
                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m8 10 4 4 4-4"/>
                        </svg>
                        <p>פעולות נוספות</p>
                        <div class="p-2 flex flex-col z-50 absolute top-10 border border-gray-200 shadow rounded-lg right-0 w-54 bg-white" x-show="moreActions">
                            <a class="nav-btn" href="{% url 'quote-edit' quote.id 'quote-detail' %}">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M11 4H7.2C6.0799 4 5.51984 4 5.09202 4.21799C4.71569 4.40974 4.40973 4.7157 4.21799 5.09202C4 5.51985 4 6.0799 4 7.2V16.8C4 17.9201 4 18.4802 4.21799 18.908C4.40973 19.2843 4.71569 19.5903 5.09202 19.782C5.51984 20 6.0799 20 7.2 20H16.8C17.9201 20 18.4802 20 18.908 19.782C19.2843 19.5903 19.5903 19.2843 19.782 18.908C20 18.4802 20 17.9201 20 16.8V12.5M15.5 5.5L18.3284 8.32843M10.7627 10.2373L17.411 3.58902C18.192 2.80797 19.4584 2.80797 20.2394 3.58902C21.0205 4.37007 21.0205 5.6364 20.2394 6.41745L13.3774 13.2794C12.6158 14.0411 12.235 14.4219 11.8012 14.7247C11.4162 14.9936 11.0009 15.2162 10.564 15.3882C10.0717 15.582 9.54378 15.6885 8.48793 15.9016L8 16L8.04745 15.6678C8.21536 14.4925 8.29932 13.9048 8.49029 13.3561C8.65975 12.8692 8.89125 12.4063 9.17906 11.9786C9.50341 11.4966 9.92319 11.0768 10.7627 10.2373Z"
                                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                               עריכה
                            </a>
                            <button class="nav-btn" @click="selectTab = 'notes'; document.getElementById('noteField').select">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 12H15M12 9V15M21.0039 12C21.0039 16.9706 16.9745 21 12.0039 21C9.9675 21 3.00463 21 3.00463 21C3.00463 21 4.56382 17.2561 3.93982 16.0008C3.34076 14.7956 3.00391 13.4372 3.00391 12C3.00391 7.02944 7.03334 3 12.0039 3C16.9745 3 21.0039 7.02944 21.0039 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                 יצירת הערה
                            </button>
                            
                            <button class="nav-btn">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 4L12 12M20 4V8.5M20 4H15.5M19 12.5V16.8C19 17.9201 19 18.4802 18.782 18.908C18.5903 19.2843 18.2843 19.5903 17.908 19.782C17.4802 20 16.9201 20 15.8 20H7.2C6.0799 20 5.51984 20 5.09202 19.782C4.71569 19.5903 4.40973 19.2843 4.21799 18.908C4 18.4802 4 17.9201 4 16.8V8.2C4 7.0799 4 6.51984 4.21799 6.09202C4.40973 5.71569 4.71569 5.40973 5.09202 5.21799C5.51984 5 6.07989 5 7.2 5H11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ייצוא
                            </button>

                            <button class="nav-btn">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 8L8.44992 11.6333C9.73295 12.4886 10.3745 12.9163 11.0678 13.0825C11.6806 13.2293 12.3194 13.2293 12.9322 13.0825C13.6255 12.9163 14.2671 12.4886 15.5501 11.6333L21 8M6.2 19H17.8C18.9201 19 19.4802 19 19.908 18.782C20.2843 18.5903 20.5903 18.2843 20.782 17.908C21 17.4802 21 16.9201 21 15.8V8.2C21 7.0799 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V15.8C3 16.9201 3 17.4802 3.21799 17.908C3.40973 18.2843 3.71569 18.5903 4.09202 18.782C4.51984 19 5.07989 19 6.2 19Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                שליחת הצעת מחיר
                            </button>
                            <hr class="text-gray-200 my-1">
                            <button class="nav-btn danger" @click="modelBackgroundShow = true, singleDeleteModelShow = true, selectedQuote = '{{quote.id}}', selectedQuoteName = '{{quote.name}}'">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6M18 6V16.2C18 17.8802 18 18.7202 17.673 19.362C17.3854 19.9265 16.9265 20.3854 16.362 20.673C15.7202 21 14.8802 21 13.2 21H10.8C9.11984 21 8.27976 21 7.63803 20.673C7.07354 20.3854 6.6146 19.9265 6.32698 19.362C6 18.7202 6 17.8802 6 16.2V6M14 10V17M10 10V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                 מחיקה
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-4 my-2">
                <h3 class="font-semibold mb-1">הערה נעוצה</h3>
                {% if tagged_note or quote.notes.all %}
                <div class="bg-yellow-200/20 p-2 rounded-lg border border-yellow-200/40 flex items-center gap-2">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="size-6">
                        <path d="M8 11H8.01M12 11H12.01M16 11H16.01M21 20L17.6757 18.3378C17.4237 18.2118 17.2977 18.1488 17.1656 18.1044C17.0484 18.065 16.9277 18.0365 16.8052 18.0193C16.6672 18 16.5263 18 16.2446 18H6.2C5.07989 18 4.51984 18 4.09202 17.782C3.71569 17.5903 3.40973 17.2843 3.21799 16.908C3 16.4802 3 15.9201 3 14.8V7.2C3 6.07989 3 5.51984 3.21799 5.09202C3.40973 4.71569 3.71569 4.40973 4.09202 4.21799C4.51984 4 5.0799 4 6.2 4H17.8C18.9201 4 19.4802 4 19.908 4.21799C20.2843 4.40973 20.5903 4.71569 20.782 5.09202C21 5.51984 21 6.0799 21 7.2V20Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p class="truncate">{% if tagged_note %}{{ tagged_note.text }}{% else %}{{ quote.notes.first.text }}{% endif %}</p>
                </div>
                {% else %}
                <div class="text-gray-500 p-2 rounded-lg">אין הודעות במערכת עבור הצעת מחיר זו...</div>
                {% endif %}
            </div>
            <div class="flex items-center justify-start mt-4 px-4">
                <button :class="selectTab=='details' ? 'btn-tab active' : 'btn-tab' " @click="selectTab='details'">פרטים</button>
                <button :class="selectTab=='activities' ? 'btn-tab active' : 'btn-tab' " @click="selectTab='activities'">פעילויות</button>
                <button :class="selectTab=='notes' ? 'btn-tab active' : 'btn-tab' " @click="selectTab='notes'">הערות</button>
            </div>
        </div>
        <!-- Tab Content Section -->
        <div class="py-2 w-full">
            <!-- Quote Detail Tab Content -->
             <div x-show="selectTab == 'details'" class="w-full">
                <div class="border-b border-gray-200 flex items-center px-4 gap-4">
                    <div class="pb-4 w-1/6">
                        <h2 class="text-xl font-semibold mb-2 mt-2">פרטי הצעת מחיר</h2>
                    </div> 
                    <div class="w-4/6 flex items-center gap-2">
                        <div class="p-2 border-r-2 border-gray-100 flex gap-2">
                            <div class="px-2 py-2 rounded-lg bg-gray-100 flex items-center">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="size-5 text-gray-400">
                                    <path d="M18 8.5V8.35417C18 6.50171 16.4983 5 14.6458 5H9.5C7.567 5 6 6.567 6 8.5C6 10.433 7.567 12 9.5 12H14.5C16.433 12 18 13.567 18 15.5C18 17.433 16.433 19 14.5 19H9.42708C7.53436 19 6 17.4656 6 15.5729V15.5M12 3V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-xs">שווי כולל</h4>
                                <span class="text-base font-semibold">{{ quote.total_price|floatformat:"0"|intcomma:False }} ₪</span>
                            </div>
                        </div>
                        <div class="p-2 border-r-2 border-gray-100 flex gap-2">
                            <div class="px-2 py-2 rounded-lg bg-gray-100 flex items-center">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="size-5 text-gray-400">
                                    <path d="M18 8.5V8.35417C18 6.50171 16.4983 5 14.6458 5H9.5C7.567 5 6 6.567 6 8.5C6 10.433 7.567 12 9.5 12H14.5C16.433 12 18 13.567 18 15.5C18 17.433 16.433 19 14.5 19H9.42708C7.53436 19 6 17.4656 6 15.5729V15.5M12 3V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-xs">שווי מע"מ</h4>
                                <span class="text-base font-semibold">{{ quote.vat_amount|floatformat:"0"|intcomma:False }} ₪</span>
                            </div>
                        </div>
                        <div class="p-2 border-r-2 border-gray-100 flex gap-2">
                            <div class="px-2 py-2 rounded-lg bg-gray-100 flex items-center">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="size-5 text-gray-400">
                                    <path d="M18 8.5V8.35417C18 6.50171 16.4983 5 14.6458 5H9.5C7.567 5 6 6.567 6 8.5C6 10.433 7.567 12 9.5 12H14.5C16.433 12 18 13.567 18 15.5C18 17.433 16.433 19 14.5 19H9.42708C7.53436 19 6 17.4656 6 15.5729V15.5M12 3V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-xs">שווי כולל מע"מ</h4>
                                <span class="text-base font-semibold">{{ quote.total_wvat_price|floatformat:"0"|intcomma:False }} ₪</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 flex flex-col gap-2">
                    <div class="border border-gray-200 rounded-lg p-2">
                        <table class="w-full relative">
                            <thead class="h-full">
                                <tr class="table-header-row">
                                    <th class="table-header-item">שירות</th>
                                    <th class="table-header-item">כמות</th>
                                    <th class="table-header-item">מחיר</th>
                                    <th class="table-header-item">סה"כ</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for service in quote.quote_services.all %}
                                <tr class="table-body-item">
                                    <td>{{ service.service.name }}</td>
                                    <td>{{ service.qty|floatformat:"0"|intcomma:False }}</td>
                                    <td>₪{{ service.price|floatformat:"0"|intcomma:False }}</td>
                                    <td>₪{{ service.total_price|floatformat:"0"|intcomma:False }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-2 flex flex-col items-end pl-19">
                        <div class="flex items-center justify-between gap-2 col-start-1 w-1/5">
                            <p class="text-gray-600">סה"כ:</p>
                            <p class="text-base">₪{{ quote.total_price|floatformat:"0"|intcomma:False }}</p>
                        </div>
                        <div class="flex items-center justify-between gap-2 col-start-1 w-1/5">
                            <p class="text-gray-600">מע"מ:</p>
                            <p class="text-base">₪{{ quote.vat_amount|floatformat:"0"|intcomma:False }}</p>
                        </div>
                        <div class="flex items-center justify-between gap-2 col-start-1 w-1/5">
                            <p class="text-gray-600">סה"כ כולל מע"מ:</p>
                            <p class="text-base">₪{{ quote.total_wvat_price|floatformat:"0"|intcomma:False }}</p>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-2">
                        <h3 class="my-1 font-semibold text-lg">תשלומים</h3>
                        <table class="w-full relative">
                            <thead class="h-full">
                                <tr class="table-header-row">
                                    <th class="table-header-item">שם תשלום</th>
                                    <th class="table-header-item">שירות</th>
                                    <th class="table-header-item">סכום</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in quote.quote_payments.all %}
                                <tr class="table-body-item">
                                    <td>{{ p.name }} ({{p.percent|floatformat:"0"|intcomma:False}}%)</td>
                                    <td>{{ p.quote_service.name }}</td>
                                    <td>₪{{ p.price|floatformat:"0"|intcomma:False }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
             </div>
            <!-- Activities Tab Content -->
            <div x-show="selectTab == 'activities'">
                <p>פעילויות</p>
            </div>
            <!-- Notes Tab Content -->
            <div x-show="selectTab == 'notes'" class="w-full">
                <div class="border-b border-gray-200 flex items-center px-4 gap-4">
                    <div class="pb-4 w-2/4">
                        <h2 class="text-xl font-semibold mb-2">הערות</h2>
                        <form 
                              method="post" class="flex items-center gap-2" action="{% url 'quote-submit-note' quote.id %}">
                            {% csrf_token %}
                            <input class="input-field" name="note" required id="noteField" maxlength="200">
                            <button class="btn-main" type="submit">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10.3009 13.6949L20.102 3.89742M10.5795 14.1355L12.8019 18.5804C13.339 19.6545 13.6075 20.1916 13.9458 20.3356C14.2394 20.4606 14.575 20.4379 14.8492 20.2747C15.1651 20.0866 15.3591 19.5183 15.7472 18.3818L19.9463 6.08434C20.2845 5.09409 20.4535 4.59896 20.3378 4.27142C20.2371 3.98648 20.013 3.76234 19.7281 3.66167C19.4005 3.54595 18.9054 3.71502 17.9151 4.05315L5.61763 8.2523C4.48114 8.64037 3.91289 8.83441 3.72478 9.15032C3.56153 9.42447 3.53891 9.76007 3.66389 10.0536C3.80791 10.3919 4.34498 10.6605 5.41912 11.1975L9.86397 13.42C10.041 13.5085 10.1295 13.5527 10.2061 13.6118C10.2742 13.6643 10.3352 13.7253 10.3876 13.7933C10.4468 13.87 10.491 13.9585 10.5795 14.1355Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </form>
                        <p class="text-xs text-gray-500">השאר הערה עבור הצעת המחיר</p>
                    </div>
                    {% if tagged_note %}
                    <div class="flex items-center w-2/4 pb-4 h-full">
                        <div class="p-4 bg-indigo-200/30 border border-indigo-100 rounded-lg flex gap-4 items-center w-full">
                            <div class="p-2 rounded-lg bg-indigo-200/60">
                                <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.99927 3V8.5C6.17801 9.86834 5 12.0466 5 14.5V15H12H19V14.5C19 12.0466 17.822 9.86834 16.0007 8.5V3M6 3H18M12 10V21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <p class="truncate w-9/10">{{tagged_note.text}}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="overflow-y-auto py-2 px-8 h-[474px] flex-col gap-2 flex w-full">
                    <div id="notes-wrapper">
                    {% if quote.notes.all %}
                    {% for note in quote.notes.all %}
                    <div class="p-2 flex items-center w-5/6" x-data="{showNoteMore : false}">
                        <div class="flex items-start gap-2 w-full">
                            <div class="[&>svg]:size-4 p-1 rounded hover:bg-gray-100 cursor-pointer relative" @click="showNoteMore = !showNoteMore" @click.outside="showNoteMore = false">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 12H18.01M12 12H12.01M6 12H6.01M13 12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12ZM19 12C19 12.5523 18.5523 13 18 13C17.4477 13 17 12.5523 17 12C17 11.4477 17.4477 11 18 11C18.5523 11 19 11.4477 19 12ZM7 12C7 12.5523 6.55228 13 6 13C5.44772 13 5 12.5523 5 12C5 11.4477 5.44772 11 6 11C6.55228 11 7 11.4477 7 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div x-show="showNoteMore" 
                                    class="p-2 flex flex-col z-100 absolute top-6 border border-gray-200 shadow rounded-lg right-2 w-44 bg-white">
                                    {% if note.tagged %}
                                    <a class="nav-btn" href="{% url 'quote-tag-note' note.id %}">
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7.99927 3V8.5C6.17801 9.86834 5 12.0466 5 14.5V15H12H19V14.5C19 12.0466 17.822 9.86834 16.0007 8.5V3M6 3H18M12 10V21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                         הורד נעיצה
                                    </a>
                                    {% else %}
                                    <a class="nav-btn" href="{% url 'quote-tag-note' note.id %}">
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7.99927 3V8.5C6.17801 9.86834 5 12.0466 5 14.5V15H12H19V14.5C19 12.0466 17.822 9.86834 16.0007 8.5V3M6 3H18M12 10V21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                         נעיצה
                                    </a>
                                    {% endif %}
                                    <hr class="text-gray-200 my-1">
                                    <a class="nav-btn danger" href="{% url 'quote-delete-note' note.id %}">
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6M18 6V16.2C18 17.8802 18 18.7202 17.673 19.362C17.3854 19.9265 16.9265 20.3854 16.362 20.673C15.7202 21 14.8802 21 13.2 21H10.8C9.11984 21 8.27976 21 7.63803 20.673C7.07354 20.3854 6.6146 19.9265 6.32698 19.362C6 18.7202 6 17.8802 6 16.2V6M14 10V17M10 10V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                         מחיקה
                                    </a>
                                </div>
                            </div>
                            <div class="icon-note">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 11H8.01M12 11H12.01M16 11H16.01M21 20L17.6757 18.3378C17.4237 18.2118 17.2977 18.1488 17.1656 18.1044C17.0484 18.065 16.9277 18.0365 16.8052 18.0193C16.6672 18 16.5263 18 16.2446 18H6.2C5.07989 18 4.51984 18 4.09202 17.782C3.71569 17.5903 3.40973 17.2843 3.21799 16.908C3 16.4802 3 15.9201 3 14.8V7.2C3 6.07989 3 5.51984 3.21799 5.09202C3.40973 4.71569 3.71569 4.40973 4.09202 4.21799C4.51984 4 5.0799 4 6.2 4H17.8C18.9201 4 19.4802 4 19.908 4.21799C20.2843 4.40973 20.5903 4.71569 20.782 5.09202C21 5.51984 21 6.0799 21 7.2V20Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="flex flex-col gap-2 relative w-full" x-data="{fold : true, showFold : document.getElementById('noteText-{{note.id}}').textContent.length > 168}">
                                <article :class="fold ? '' : 'text-wrap' " class="flex flex-col gap-1 w-9/10 transition-all duration-100">
                                    <p :class="fold ? 'truncate' : 'wrap-break-word' " class="transition-all duration-100" id="noteText-{{note.id}}" x-transition>{{ note.text }}</p>
                                    <span class="text-gray-600 text-xs">{{ note.created_at }}</span>
                                </article>
                                <span class="absolute top-0 -left-20 hover:bg-gray-100 rounded-lg cursor-pointer" @click="fold = !fold" x-show="showFold">
                                    <svg :class="fold ? 'size-5 transition duration-100' : 'size-5 rotate-180 transition duration-100' " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m8 10 4 4 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="border-dashed border-2 border-gray-200 flex flex-col items-center justify-center rounded-xl p-6 gap-4 text-center">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-gray-400 size-24">
                            <path d="M21 20L20.5528 20.8944C20.8628 21.0494 21.2309 21.0329 21.5257 20.8507C21.8205 20.6684 22 20.3466 22 20H21ZM16.8052 18.0193L16.9438 17.029L16.8052 18.0193ZM17.6757 18.3378L17.2285 19.2323L17.6757 18.3378ZM17.1656 18.1044L16.8467 19.0522L17.1656 18.1044ZM3.21799 16.908L4.10899 16.454L3.21799 16.908ZM4.09202 17.782L4.54601 16.891L4.09202 17.782ZM19.908 4.21799L19.454 5.10899L19.908 4.21799ZM20.782 5.09202L19.891 5.54601L20.782 5.09202ZM4.09202 4.21799L4.54601 5.10899L4.09202 4.21799ZM3.21799 5.09202L4.10899 5.54601L3.21799 5.09202ZM11.2602 11.0429C10.8697 11.4334 10.8697 12.0666 11.2602 12.4571C11.6507 12.8476 12.2839 12.8476 12.6744 12.4571L11.2602 11.0429ZM9.06184 8.50074C8.92417 9.03559 9.24616 9.58078 9.78101 9.71844C10.3159 9.8561 10.861 9.53411 10.9987 8.99926L9.06184 8.50074ZM11.9668 13.75C11.4145 13.75 10.9668 14.1977 10.9668 14.75C10.9668 15.3023 11.4145 15.75 11.9668 15.75V13.75ZM11.9768 15.75C12.5291 15.75 12.9768 15.3023 12.9768 14.75C12.9768 14.1977 12.5291 13.75 11.9768 13.75V15.75ZM6.2 5H17.8V3H6.2V5ZM4 14.8V7.2H2V14.8H4ZM16.2446 17H6.2V19H16.2446V17ZM21.4472 19.1056L18.1229 17.4434L17.2285 19.2323L20.5528 20.8944L21.4472 19.1056ZM16.2446 19C16.553 19 16.6133 19.0022 16.6665 19.0097L16.9438 17.029C16.7211 16.9978 16.4996 17 16.2446 17V19ZM18.1229 17.4434C17.8948 17.3294 17.6977 17.2283 17.4845 17.1566L16.8467 19.0522C16.8977 19.0693 16.9526 19.0943 17.2285 19.2323L18.1229 17.4434ZM16.6665 19.0097C16.7278 19.0182 16.7881 19.0325 16.8467 19.0522L17.4845 17.1566C17.3086 17.0974 17.1276 17.0547 16.9438 17.029L16.6665 19.0097ZM2 14.8C2 15.3436 1.99922 15.8114 2.03057 16.195C2.06287 16.5904 2.13419 16.9836 2.32698 17.362L4.10899 16.454C4.0838 16.4045 4.04612 16.3038 4.02393 16.0322C4.00078 15.7488 4 15.3766 4 14.8H2ZM6.2 17C5.62345 17 5.25117 16.9992 4.96784 16.9761C4.69617 16.9539 4.59545 16.9162 4.54601 16.891L3.63803 18.673C4.01641 18.8658 4.40963 18.9371 4.80497 18.9694C5.18864 19.0008 5.65645 19 6.2 19V17ZM2.32698 17.362C2.6146 17.9265 3.07354 18.3854 3.63803 18.673L4.54601 16.891C4.35785 16.7951 4.20487 16.6422 4.10899 16.454L2.32698 17.362ZM17.8 5C18.3766 5 18.7488 5.00078 19.0322 5.02393C19.3038 5.04612 19.4045 5.0838 19.454 5.10899L20.362 3.32698C19.9836 3.13419 19.5904 3.06287 19.195 3.03057C18.8114 2.99922 18.3436 3 17.8 3V5ZM22 7.2C22 6.65645 22.0008 6.18864 21.9694 5.80497C21.9371 5.40963 21.8658 5.01641 21.673 4.63803L19.891 5.54601C19.9162 5.59545 19.9539 5.69617 19.9761 5.96784C19.9992 6.25117 20 6.62345 20 7.2H22ZM19.454 5.10899C19.6422 5.20487 19.7951 5.35785 19.891 5.54601L21.673 4.63803C21.3854 4.07354 20.9265 3.6146 20.362 3.32698L19.454 5.10899ZM6.2 3C5.65645 3 5.18864 2.99922 4.80497 3.03057C4.40963 3.06287 4.01641 3.13419 3.63803 3.32698L4.54601 5.10899C4.59545 5.0838 4.69617 5.04612 4.96784 5.02393C5.25117 5.00078 5.62345 5 6.2 5V3ZM4 7.2C4 6.62345 4.00078 6.25117 4.02393 5.96784C4.04612 5.69617 4.0838 5.59545 4.10899 5.54601L2.32698 4.63803C2.13419 5.01641 2.06287 5.40963 2.03057 5.80497C1.99922 6.18864 2 6.65645 2 7.2H4ZM3.63803 3.32698C3.07354 3.6146 2.6146 4.07354 2.32698 4.63803L4.10899 5.54601C4.20487 5.35785 4.35785 5.20487 4.54601 5.10899L3.63803 3.32698ZM12.9673 9.25C12.9673 9.42317 12.9218 9.55527 12.6478 9.81968C12.4941 9.96803 12.3131 10.1153 12.0622 10.324C11.8238 10.5223 11.5443 10.7587 11.2602 11.0429L12.6744 12.4571C12.8902 12.2413 13.1107 12.0533 13.3412 11.8616C13.5589 11.6805 13.8154 11.4723 14.0367 11.2587C14.5128 10.7993 14.9673 10.1814 14.9673 9.25H12.9673ZM11.9673 8.25C12.5195 8.25 12.9673 8.69772 12.9673 9.25H14.9673C14.9673 7.59315 13.6241 6.25 11.9673 6.25V8.25ZM10.9987 8.99926C11.1098 8.56774 11.5027 8.25 11.9673 8.25V6.25C10.568 6.25 9.39481 7.20704 9.06184 8.50074L10.9987 8.99926ZM11.9668 15.75H11.9768V13.75H11.9668V15.75ZM20 7.2V20H22V7.2H20Z" fill="currentColor"/>
                        </svg>
                        <div class="flex flex-col gap-2">
                            <h3 class="text-xl font-semibold">לא קיימות הערות עבור הצעת מחיר זו עדיין</h3>
                            <p class="text-gray-400">הוסף הערה חדשה עכשיו<br>תוכל לראות את ההערה האחרונה בראש הדף</p>
                        </div>
                    </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Details Section -->
    <div class="border-r border-gray-200 px-6 py-8 h-full w-1/4" x-data="{showContact : true , showAdditional : true, showQuoteInfo : true}">
        <div class="flex items-center justify-between">
            <h3 class="text-base font-semibold mb-4">פרטי יצירת קשר</h3>
            <button class="btn-normal transition-all duration-300" @click="showContact=!showContact">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" x-transition :class="showContact ? 'transition-all duration-150' : 'transition-all duration-360 rotate-x-180' ">
                    <path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        
        <div class="grid grid-cols-3 px-2 gap-2 items-center" x-show="showContact" x-collapse.duration.500ms>
            <p class="text-gray-500">מקושר ל</p>
            <a class="col-span-2 btn-ghost w-fit" href="{% url related_to_url quote.object_id %}">
                {% if quote.content_object.logo %}
                <img src="{{quote.content_object.logo.url}}" alt="Customer Logo" class="squircle w-6 h-6">
                {% endif %}
                {{quote.related_to}}
            </a>
            <p class="text-gray-500">טלפון</p>
            <p class="flex items-center gap-1 [&>svg]:size-4 col-span-2">
                {% if quote.content_object.phone %}
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 5.5C3 14.0604 9.93959 21 18.5 21C18.8862 21 19.2691 20.9859 19.6483 20.9581C20.0834 20.9262 20.3009 20.9103 20.499 20.7963C20.663 20.7019 20.8185 20.5345 20.9007 20.364C21 20.1582 21 19.9181 21 19.438V16.6207C21 16.2169 21 16.015 20.9335 15.842C20.8749 15.6891 20.7795 15.553 20.6559 15.4456C20.516 15.324 20.3262 15.255 19.9468 15.117L16.74 13.9509C16.2985 13.7904 16.0777 13.7101 15.8683 13.7237C15.6836 13.7357 15.5059 13.7988 15.3549 13.9058C15.1837 14.0271 15.0629 14.2285 14.8212 14.6314L14 16C11.3501 14.7999 9.2019 12.6489 8 10L9.36863 9.17882C9.77145 8.93713 9.97286 8.81628 10.0942 8.64506C10.2012 8.49408 10.2643 8.31637 10.2763 8.1317C10.2899 7.92227 10.2096 7.70153 10.0491 7.26005L8.88299 4.05321C8.745 3.67376 8.67601 3.48403 8.55442 3.3441C8.44701 3.22049 8.31089 3.12515 8.15802 3.06645C7.98496 3 7.78308 3 7.37932 3H4.56201C4.08188 3 3.84181 3 3.63598 3.09925C3.4655 3.18146 3.29814 3.33701 3.2037 3.50103C3.08968 3.69907 3.07375 3.91662 3.04189 4.35173C3.01413 4.73086 3 5.11378 3 5.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                {{quote.content_object.phone_number}}
                {% endif %}
            </p>
            <p class="text-gray-500">אימייל</p>
            <p class="flex items-center gap-1 [&>svg]:size-4 col-span-2">
                {% if quote.content_object.email %}
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 8L8.44992 11.6333C9.73295 12.4886 10.3745 12.9163 11.0678 13.0825C11.6806 13.2293 12.3194 13.2293 12.9322 13.0825C13.6255 12.9163 14.2671 12.4886 15.5501 11.6333L21 8M6.2 19H17.8C18.9201 19 19.4802 19 19.908 18.782C20.2843 18.5903 20.5903 18.2843 20.782 17.908C21 17.4802 21 16.9201 21 15.8V8.2C21 7.0799 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V15.8C3 16.9201 3 17.4802 3.21799 17.908C3.40973 18.2843 3.71569 18.5903 4.09202 18.782C4.51984 19 5.07989 19 6.2 19Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                {{quote.content_object.email}}
                {% endif %}
            </p>
            {% if quote.content_object.company_name %}
            <p class="text-gray-500">שם חברה</p>
            <p class="col-span-2">{{quote.content_object.company_name}}</p>
            {% endif %}
            <p class="text-gray-500">סטטוס</p>
            <span class="w-fit status-pill {% if quote.status == 'draft' %}info{% elif quote.status == 'lost' %}danger{% elif quote.status == 'won' %}success{% elif quote.status == 'sent' %}proccess{% endif %}">{{quote.get_status_display}}</span>
        </div>
        <hr class="text-gray-200 font-bold my-4">
        
        <div class="flex items-center justify-between">
            <h3 class="text-base font-semibold mb-4">פרטי הצעת מחיר</h3>
            <button class="btn-normal transition-all duration-300" @click="showQuoteInfo=!showQuoteInfo">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" x-transition :class="showQuoteInfo ? 'transition-all duration-150' : 'transition-all duration-360 rotate-x-180' ">
                    <path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="grid grid-cols-3 px-4 gap-2 items-center" x-show="showQuoteInfo" x-collapse.duration.500ms>
            <p class="text-gray-500">מספר הצעת מחיר</p>
            <span class="col-span-2 rounded-lg text-xs bg-gray-200 px-2 py-1 w-fit">{{ quote.quote_number }}</span>
            <p class="text-gray-500">שירותים</p>
            <div class="col-span-2 flex flex-col gap-1">
                {% for ser in quote.quote_services.all %}
                <span class="border border-gray-200 px-1 py-0.5 rounded-lg w-fit">{{ ser.service }}</span>
                {% endfor %}
            </div>
            <p class="text-gray-500">מחיר כולל</p>
            <p class="col-span-2">₪{{quote.total_price|floatformat:"0"|intcomma:False}}</p>
            <p class="text-gray-500">שווי מע"מ</p>
            <p class="col-span-2">₪{{quote.vat_amount|floatformat:"0"|intcomma:False}}</p>
            <p class="text-gray-500">מחיר כולל מע"מ</p>
            <p class="col-span-2">₪{{quote.total_wvat_price|floatformat:"0"|intcomma:False}}</p>
        </div>
        <hr class="text-gray-200 font-bold my-4">
        <div class="flex items-center justify-between">
            <h3 class="text-base font-semibold mb-4">פרטים נוספים</h3>
            <button class="btn-normal transition-all duration-300" @click="showAdditional=!showAdditional">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" x-transition :class="showAdditional ? 'transition-all duration-150' : 'transition-all duration-360 rotate-x-180' ">
                    <path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="grid grid-cols-3 px-4 gap-2 items-center" x-show="showAdditional" x-collapse.duration.500ms>
            <p class="text-gray-500">מקור ליד</p>
            <span class="col-span-2 rounded-lg text-xs bg-gray-200 px-2 py-1 w-fit">{% if quote.content_object.lead_source %}{{quote.content_object.lead_source.name}}{% endif %}</span>
            <p class="text-gray-500">תאריך יצירה</p>
            <p class="col-span-2">{{quote.created_at}}</p>
            <p class="text-gray-500">תאריך עדכון אחרון</p>
            <p class="col-span-2">{{quote.updated_at}}</p>
        </div>
        
    </div>
    <div class="fixed top-0 right-0 h-screen w-screen bg-black/30 flex items-start justify-center pt-60" x-show="modelBackgroundShow" x-cloak>
        <!-- Delete Confirmation Model For Single Quote-->
        <div class="relative bg-white border border-gray-200 shadow rounded-lg px-4 py-4 min-w-1/4 min-h-1/5 flex flex-col" x-show="singleDeleteModelShow" x-cloak>
            <button class="absolute top-2 left-2 [&>svg]:size-6 p-0.5 rounded hover:bg-gray-50 cursor-pointer" @click="modelBackgroundShow = false, quoteDeleteModelShow = false">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 6L18 18M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="flex-1">
                <h1 class="text-xl font-semibold my-3">מחיקת הצעת מחיר</h1>
                <span class="flex gap-2 items-center">
                    <p class="text-gray-500">אתה עומד למחוק את</p>
                    <p class="text-gray-900 text-semibold" x-text="selectedQuoteName"></p>
                </span>
                <p class="text-gray-500">פעולה זו אינה ניתנת לשחזור</p>
            </div>
            <div class="flex items-center justify-end gap-2">
                <form method="post" :action="'{% url 'quote-delete' pk=999999 %}'.replace('999999', selectedQuote)">
                    {% csrf_token %}
                    <input type="text" name="fallback" value="quote-list" class="hidden">
                    <button class="btn-action danger high" type="submit">
                     מחיקה
                    </button>
                </form>
                
                <button class="btn-action" @click="modelBackgroundShow = false, quoteDeleteModelShow = false">
                    ביטול
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function setSection() {
        return {
            selectTab : "details",

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                const section = urlParams.get('section');
                if (section) {
                    this.selectTab = section;
                    // clear the query parameter from URL bar after reading
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
    }
</script>

{% endblock content %}